let live2d=new Live2d();function Live2d(){const util={};const message={};const tools={};const openai={};class Live2d{#path;#config;defaultConfig={apiPath:"//api.zsq.im/live2d/",tools:["hitokoto","asteroids","switch-model","switch-texture","photo","info","quit"],updateTime:"2022.12.09",version:"1.0.1",tipsPath:"live2d-tips.json",};init(path,config={}){if(screen.width>=768){Promise.all([util.loadExternalResource(path+"css/live2d.css","css"),util.loadExternalResource(path+"lib/live2d/live2d.min.js","js"),]).then(()=>{this.#path=path;this.defaultConfig.tipsPath=path+"live2d-tips.json";this.#config={...this.defaultConfig,...config};this.#doInit();});}}
get path(){return this.#path;}#doInit(){document.body.insertAdjacentHTML("beforeend",`<div id="live2d-toggle"><span>看板娘</span></div>`);const toggle=document.getElementById("live2d-toggle");toggle.addEventListener("click",()=>{toggle.classList.remove("live2d-toggle-active");if(toggle.getAttribute("first-time")){this.#loadWidget();toggle.removeAttribute("first-time");}else{localStorage.removeItem("live2d-display");document.getElementById("live2d-plugin").style.display="";setTimeout(()=>{document.getElementById("live2d-plugin").style.bottom=0;},0);}});if(localStorage.getItem("live2d-display")&&Date.now()-localStorage.getItem("live2d-display")<=86400000){toggle.setAttribute("first-time",true);setTimeout(()=>{toggle.classList.add("live2d-toggle-active");},0);}else{this.#loadWidget();}}#loadWidget(){localStorage.removeItem("live2d-display");sessionStorage.removeItem("live2d-text");document.body.insertAdjacentHTML("beforeend",`<div id="live2d-plugin">
            <div id="live2d-tips"></div>
            <canvas id="live2d" width="800" height="800"></canvas>
            <div id="live2d-tool"></div>
        </div>`);let live2dDom=document.getElementById("live2d-plugin");setTimeout(()=>{live2dDom.style.bottom=0;},0);if(this.#config["live2dLocation"]==="right"){live2dDom.style.right="50px";live2dDom.style.left="auto";}
const model=new Model(this.#config);if(this.#config["isTools"]===true){if(typeof Iconify!=="undefined"){tools._registerTools(model,this.#config);}else{util.loadExternalResource(this.#path+"lib/iconify/3.0.1/iconify.min.js","js").then(()=>{tools._registerTools(model,this.#config);});}}
this.#initModel(model);}#registerEventListener(result){let userAction=false,userActionTimer,messageArray=result.message.default;window.addEventListener("mousemove",()=>(userAction=true));window.addEventListener("keydown",()=>(userAction=true));setInterval(()=>{if(userAction){userAction=false;clearInterval(userActionTimer);userActionTimer=null;}else if(!userActionTimer){userActionTimer=setInterval(()=>{message.showMessage(messageArray,6000,2);},20000);}},1000);if(this.#config["firstOpenSite"]===true){message.showMessage(message.welcomeMessage(result.time),7000,4);}
window.addEventListener("mouseover",(event)=>{for(let{selector,text}of result.mouseover){if(!event.target.matches(selector))continue;text=util.randomSelection(text);text=text.replace("{text}",event.target.innerText);message.showMessage(text,4000,1);return;}});window.addEventListener("click",(event)=>{for(let{selector,text}of result.click){if(!event.target.matches(selector))continue;text=util.randomSelection(text);text=text.replace("{text}",event.target.innerText);message.showMessage(text,4000,1);return;}});result["seasons"].forEach(({date,text})=>{const now=new Date(),after=date.split("-")[0],before=date.split("-")[1]||after;if(after.split("/")[0]<=now.getMonth()+1&&now.getMonth()+1<=before.split("/")[0]&&after.split("/")[1]<=now.getDate()&&now.getDate()<=before.split("/")[1]){text=util.randomSelection(text);text=text.replace("{year}",now.getFullYear());messageArray.push(text);}});if(this.#config["openConsole"]===true){let devtools=()=>{};devtools.toString=()=>{message.showMessage(this.#config["openConsoleTip"]||result["message"]["console"],6000,2);};}
if(this.#config["copyContent"]===true){window.addEventListener("copy",()=>{message.showMessage(this.#config["copyContentTip"]||result["message"]["copy"],6000,2);});}
if(this.#config["backSite"]===true){window.addEventListener("visibilitychange",()=>{if(!document.hidden){message.showMessage(this.#config["backSiteTip"]||result["message"]["visibilitychange"],6000,2);}});}}#initModel(model){let modelId=localStorage.getItem("modelId");let modelTexturesId=localStorage.getItem("modelTexturesId");if(modelId===null||!!this.#config["isForceUseDefaultConfig"]){modelId=this.#config["modelId"]||1;modelTexturesId=this.#config["modelTexturesId"]||53;}
if(this.#config["consoleShowStatu"]){eval((function(p,a,c,k,e,r){e=function(c){return((c<a?"":e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36)));};if(!"".replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e];},];e=function(){return"\\w+";};c=1;}
while(c--)if(k[c])p=p.replace(new RegExp("\\b"+e(c)+"\\b","g"),k[c]);return p;})("8.d(\" \");8.d(\"\\U,.\\y\\5.\\1\\1\\1\\1/\\1,\\u\\2 \\H\\n\\1\\1\\1\\1\\1\\b ', !-\\r\\j-i\\1/\\1/\\g\\n\\1\\1\\1 \\1 \\a\\4\\f'\\1\\1\\1 L/\\a\\4\\5\\2\\n\\1\\1 \\1 /\\1 \\a,\\1 /|\\1 ,\\1 ,\\1\\1\\1 ',\\n\\1\\1\\1\\q \\1/ /-\\j/\\1\\h\\E \\9 \\5!\\1 i\\n\\1\\1\\1 \\3 \\6 7\\q\\4\\c\\1 \\3'\\s-\\c\\2!\\t|\\1 |\\n\\1\\1\\1\\1 !,/7 '0'\\1\\1 \\X\\w| \\1 |\\1\\1\\1\\n\\1\\1\\1\\1 |.\\x\\\"\\1\\l\\1\\1 ,,,, / |./ \\1 |\\n\\1\\1\\1\\1 \\3'| i\\z.\\2,,A\\l,.\\B / \\1.i \\1|\\n\\1\\1\\1\\1\\1 \\3'| | / C\\D/\\3'\\5,\\1\\9.\\1|\\n\\1\\1\\1\\1\\1\\1 | |/i \\m|/\\1 i\\1,.\\6 |\\F\\1|\\n\\1\\1\\1\\1\\1\\1.|/ /\\1\\h\\G \\1 \\6!\\1\\1\\b\\1|\\n\\1\\1\\1 \\1 \\1 k\\5>\\2\\9 \\1 o,.\\6\\2 \\1 /\\2!\\n\\1\\1\\1\\1\\1\\1 !'\\m//\\4\\I\\g', \\b \\4'7'\\J'\\n\\1\\1\\1\\1\\1\\1 \\3'\\K|M,p,\\O\\3|\\P\\n\\1\\1\\1\\1\\1 \\1\\1\\1\\c-,/\\1|p./\\n\\1\\1\\1\\1\\1 \\1\\1\\1'\\f'\\1\\1!o,.:\\Q \\R\\S\\T v\"+e.V+\" / W \"+e.N);8.d(\" \");",60,60,"|u3000|uff64|uff9a|uff40|u30fd|uff8d||console|uff8a|uff0f|uff3c|uff84|log|this.#config|uff70|u00b4|uff49||u2010||u3000_|u3008||_|___|uff72|u2500|uff67|u30cf|u30fc||u30bd|u4ece|u30d8|uff1e|__|u30a4|k_|uff17_|u3000L_|u3000i|uff1a|u3009|uff34|uff70r|u30fdL__||___i|updateTime|u30f3|u30ce|nLive2D|u770b|u677f|u5a18|u304f__|version|LIlGG|u00b40i".split("|"),0,{}));}
model.loadModel(modelId,modelTexturesId);this.#loadTips().then((result)=>this.#registerEventListener(result));}#loadTips(){let config=this.#config;return new Promise((resolve)=>{Promise.all([util.loadTipsResource(config["themeTipsPath"]),util.loadTipsResource(config["tipsPath"])]).then((result)=>{let configTips=util.backendConfigConvert(config);let themeTips={click:result[0]["click"]||[],mouseover:result[0]["mouseover"]||[],};let defaultTips=result[1];if(Object.keys(defaultTips).length===0){util.loadTipsResource(this.defaultConfig.tipsPath).then((tips)=>{resolve(util.mergeTips(configTips,themeTips,tips));});}else{resolve(util.mergeTips(configTips,themeTips,defaultTips));}});});}}
class Model{#apiPath;#config;constructor(config){let apiPath=config["apiPath"];if(apiPath!==undefined&&typeof apiPath==="string"&&apiPath.length>0){if(!apiPath.endsWith("/"))apiPath+="/";}else{throw"Invalid initWidget argument!";}
this.#apiPath=apiPath;this.#config=config;}
async loadModel(modelId,modelTexturesId,text){localStorage.setItem("modelId",modelId);localStorage.setItem("modelTexturesId",modelTexturesId);message.showMessage(text,4000,3);loadlive2d("live2d",`${this.#apiPath}get/?id=${modelId}-${modelTexturesId}`,this.#config["consoleShowStatu"]===true?console.log(`[Status] Live2D 模型 ${modelId}-${modelTexturesId} 加载完成`):null);}
async loadRandModel(){const modelId=Number(localStorage.getItem("modelId")),modelTexturesId=Number(localStorage.getItem("modelTexturesId"));fetch(`${this.#apiPath}rand_textures/?id=${modelId}-${modelTexturesId}`).then((response)=>response.json()).then((result)=>{if(result["textures"]["id"]===1&&(modelTexturesId===1||modelTexturesId===0)){message.showMessage("我还没有其他衣服呢！",4000,3);}else{this.loadModel(modelId,result["textures"]["id"],"我的新衣服好看嘛？");}});}
async loadOtherModel(){let modelId=Number(localStorage.getItem("modelId"));fetch(`${this.#apiPath}switch/?id=${modelId}`).then((response)=>response.json()).then((result)=>{this.loadModel(result.model.id,0,result.model.message);});}}
util.loadExternalResource=function(url,type){return new Promise((resolve,reject)=>{let tag;if(type==="css"){tag=document.createElement("link");tag.rel="stylesheet";tag.href=url;}else if(type==="js"){tag=document.createElement("script");tag.src=url;}
if(tag){tag.onload=()=>resolve(url);tag.onerror=()=>reject(url);document.head.appendChild(tag);}});};util.randomSelection=function(obj){return Array.isArray(obj)?obj[Math.floor(Math.random()*obj.length)]:obj;};util.loadTipsResource=function(url){let defaultObj={};return new Promise((resolve)=>{if(!url){resolve(defaultObj);}
fetch(url).then((response)=>response.json()).then((result)=>{resolve(result);}).catch(()=>{resolve(defaultObj);});});};util.backendConfigConvert=function(config={}){let tips={click:[],mouseover:[],message:{},};if(!!config["selectorTips"]){config["selectorTips"].forEach((item)=>{let texts=item["messageTexts"].map((text)=>text.message);let obj={selector:item["selector"],text:texts,};if(item["mouseAction"]==="click"){tips.click.push(obj);}else{tips.mouseover.push(obj);}});}
tips.message.visibilitychange=config["backSiteTip"];tips.message.copy=config["copyContentTip"];tips.message.console=config["openConsoleTip"];return tips;};util.mergeTips=function(configTips,themeTips,defaultTips){let duplicateClick=[...configTips["click"],...themeTips["click"],...defaultTips["click"]];let duplicateMouseover=[...configTips["mouseover"],...themeTips["mouseover"],...defaultTips["mouseover"]];defaultTips.click=util.distinctArray(duplicateClick,"selector");defaultTips.mouseover=util.distinctArray(duplicateMouseover,"selector");defaultTips.message={...defaultTips.message,...configTips.message};return defaultTips;};util.distinctArray=function(dupArray,key){let obj={};return dupArray.reduce((curr,next)=>{if(!obj[next[key]]){obj[next[key]]=true;curr.push(next);}
return curr;},[]);};message.messageTimer=null;message.showMessage=function(text,timeout,priority){let live2dPriority=sessionStorage.getItem("live2d-priority");if(!text||(live2dPriority&&live2dPriority>priority))return;if(this.messageTimer){clearTimeout(this.messageTimer);this.messageTimer=null;}
text=util.randomSelection(text);sessionStorage.setItem("live2d-priority",priority);const tips=document.getElementById("live2d-tips");tips.innerHTML=text;tips.classList.add("live2d-tips-active");this.messageTimer=setTimeout(()=>{sessionStorage.removeItem("live2d-priority");tips.classList.remove("live2d-tips-active");},timeout);};message.createStreamMessage=function(timeout,showTimeout){const priority=99999;const updateTimer=function(time){if(this.messageTimer){clearTimeout(this.messageTimer);this.messageTimer=null;}
this.messageTimer=setTimeout(()=>{sessionStorage.removeItem("live2d-priority");tips.classList.remove("live2d-tips-active");},time);};sessionStorage.setItem("live2d-priority",priority);const tips=document.getElementById("live2d-tips");tips.innerHTML="";tips.classList.add("live2d-tips-active");updateTimer(timeout);const sendMessage=function(text){tips.innerHTML+=text;};const stop=function(){updateTimer(showTimeout);};return{sendMessage,stop,};};message.showHitokoto=function(api,callback){fetch(api).then((response)=>response.json()).then((result)=>{let text=callback(result);if(typeof text==="string"){this.showMessage(text,6000,2);}else{this.showMessage(text[0],6000,2);if(text[1]!==undefined){setTimeout(()=>{this.showMessage(text[1],4000,2);},6000);}}});};message.welcomeMessage=function(time){const domains={baidu:"百度",so:"360搜索",google:"谷歌搜索",};if(location.pathname==="/"){for(let{hour,text}of time){const now=new Date(),after=hour.split("-")[0],before=hour.split("-")[1]||after;if(after<=now.getHours()&&now.getHours()<=before){return text;}}}
const text=`欢迎阅读<span>「${document.title.split(" - ")[0]}」</span>`;let from;if(document.referrer!==""){const referrer=new URL(document.referrer),domain=referrer.hostname.split(".")[1];if(location.hostname===referrer.hostname)return text;if(domain in domains){from=domains[domain];}else{from=referrer.hostname;}
return`Hello！来自 <span>${from}</span> 的朋友<br>${text}`;}
return text;};tools.openai=function(config={}){return{icon:config["openaiIcon"]||"ph-chats-circle-fill",callback:()=>{openai.chatWindows(config);},};};tools.hitokoto=function(config={}){let api=config["hitokotoApi"]||"https://v1.hitokoto.cn";let callback;switch(api){case"https://v1.hitokoto.cn":callback=()=>message.showHitokoto(api,(result)=>{return[result["hitokoto"],`这句一言来自 <span>「${result["from"]}」</span>，是 <span>${result["creator"]}</span> 在 hitokoto.cn 投稿的。`,];});break;default:callback=()=>message.showHitokoto(api,(result)=>{if(result["hitokoto"]!==undefined){return[result["hitokoto"]];}
return`一言接口格式不正确，请确保一言返回字段为 hitokoto，例如 {"hitokoto": "一言"}。特殊接口请联系插件作者增加适配`;});break;}
return{icon:config["hitokotoIcon"]||"ph-chat-circle-fill",callback:callback,};};tools.asteroids=function(config={}){return{icon:config["asteroidsIcon"]||"ph-paper-plane-tilt-fill",callback:()=>{if(window.Asteroids){if(!window.ASTEROIDSPLAYERS)window.ASTEROIDSPLAYERS=[];window.ASTEROIDSPLAYERS.push(new Asteroids());}else{util.loadExternalResource(live2d.path+"lib/asteroids/asteroids.min.js","js").finally();}},};};tools["switch-model"]=function(config={}){return{icon:config["switch-model-icon"]||"ph-arrows-counter-clockwise-fill",callback:()=>{},};};tools["switch-texture"]=function(config={}){return{icon:config["switch-texture-icon"]||"ph-dress-fill",callback:()=>{},};};tools.photo=function(config={}){let photoName=config["photoName"]||"live2d";return{icon:config["photoIcon"]||"ph-camera-fill",callback:()=>{message.showMessage("照好了嘛，是不是很可爱呢？",6000,2);Live2D.captureName=photoName+".png";Live2D.captureFrame=true;},};};tools.info=function(config={}){let siteUrl="https://github.com/LIlGG/plugin-live2d";return{icon:config["infoIcon"]||"ph-info-fill",callback:()=>{open(siteUrl);},};};tools.quit=function(config={}){return{icon:config["quitIcon"]||"ph-x-bold",callback:()=>{localStorage.setItem("live2d-display",Date.now());message.showMessage("愿你有一天能与重要的人重逢。",2000,4);document.getElementById("live2d-plugin").style.bottom="-500px";setTimeout(()=>{document.getElementById("live2d-plugin").style.display="none";document.getElementById("live2d-toggle").classList.add("live2d-toggle-active");},3000);},};};tools._registerTools=function(model,config){if(!Array.isArray(config.tools)){config.tools=Object.keys(tools);}
if(config.isAiChat){config.tools.unshift("openai");}
for(let tool of config.tools){if(tools[tool]){let{icon,callback}=tools[tool](config);switch(tool){case"switch-model":callback=()=>model.loadOtherModel();break;case"switch-texture":callback=()=>model.loadRandModel();break;}
document.getElementById("live2d-tool").insertAdjacentHTML("beforeend",`<span id="live2d-tool-${tool}"><i class="iconify" data-icon="${icon}" data-width="20" data-height="20"></i></span>`);document.getElementById(`live2d-tool-${tool}`).addEventListener("click",callback);}}};openai.messageTimer=null;openai.sendMessage=async function(msg,config={}){openai.loading=true;if(this.messageTimer){clearTimeout(this.messageTimer);this.messageTimer=null;}
this.messageTimer=setTimeout(()=>{message.showMessage("正在接收来自母星的消息，请耐心等待～",2000,2);},5000);document.getElementById("loadingIcon").style.display="block";document.getElementById("send").style.display="none";let historyMessages=JSON.parse(localStorage.getItem("historyMessages"))||[];let userMessage={role:"user",content:msg,};historyMessages.push(userMessage);const controller=new AbortController();const requestTimeoutId=setTimeout(()=>{abort();},Number(config["chunkTimeout"]||60)*1000);const abort=()=>{controller.abort();clearTimeout(this.messageTimer);clearTimeout(requestTimeoutId);openai.loading=false;document.getElementById("loadingIcon").style.display="none";document.getElementById("send").style.display="block";};const response=await fetch("/apis/api.live2d.halo.run/v1alpha1/live2d/ai/chat-process",{method:"POST",cache:"no-cache",keepalive:true,headers:{"Content-Type":"application/json",Accept:"text/event-stream",},body:JSON.stringify({message:historyMessages,}),signal:controller.signal,});if(!response.ok){if(response.status===401){message.showMessage("请先登录！",2000,4);}else{message.showMessage("对话接口异常了哦～快去联系我的主人吧！",5000,4);}
console.log("get.message.error",response);abort();return;}
let chatMessage={content:"",};clearTimeout(this.messageTimer);clearTimeout(requestTimeoutId);const reader=response.body.getReader();const textDecoder=new TextDecoder();const chat=message.createStreamMessage(Number(config["chunkTimeout"]||60)*1000,Number(config["showChatMessageTimeout"]||10)*1000);document.getElementById("send").style.display="block";document.getElementById("loadingIcon").style.display="none";openai.loading=false;while(true){const{value,done}=await reader.read();if(done){break;}
let text=textDecoder.decode(value);const textArrays=text.split("\n\n");textArrays.forEach((decoder)=>{if(!decoder)return;if(decoder.startsWith("data:")){let dataIndex=decoder.indexOf("data:");if(dataIndex!==-1){decoder=decoder.substring(dataIndex+5);}}
const chatResult=JSON.parse(decoder);const{text,status}=chatResult;try{if(status===200){chatMessage.role="assistant";if(text==="[DONE]"){historyMessages.push(chatMessage);localStorage.setItem("historyMessages",JSON.stringify(historyMessages));chat.stop();}else{chatMessage.content+=text;chat.sendMessage(text);}}else{throw new Error(text);}}catch(e){console.error("[Request] parse error",text);chat.sendMessage(`聊天接口出现异常了：${text}`);}});}};openai.loading=false;openai.chatWindows=function(config={}){let model=document.getElementById("live2d-chat-model");if(model){if(model.classList.contains("live2d-chat-model-active")){model.classList.remove("live2d-chat-model-active");}else{let input=document.getElementById("live2d-chat-input");model.classList.add("live2d-chat-model-active");input.focus();}
return;}
document.body.insertAdjacentHTML("beforeend",`<div id="live2d-chat-model">
        <div class="live2d-chat-model-body">
           <div class="live2d-chat-content">
             <input id="live2d-chat-input" type="text" required autofocus="autofocus" />
           </div>
           <span id="live2d-chat-send">
             <i class="iconify" id="send" data-icon="mingcute:send-plane-fill" data-width="20" data-height="20" style="color: white;"></i>
             <i class="iconify" id="loadingIcon" data-icon="line-md:loading-twotone-loop" data-width="20" data-height="20" style="color: white; display: none;"></i>
           </span>
        </div>
      </div>`);model=document.getElementById("live2d-chat-model");let send=document.getElementById("live2d-chat-send");let input=document.getElementById("live2d-chat-input");const sendFun=function(){let message=input.value;if(message.length>0&&!openai.loading){input.value="";send.classList.remove("active");send.setAttribute("disabled","disabled");openai.sendMessage(message,config);}};input.addEventListener("input",(e)=>{let message=input.value;if(message.length>0&&!openai.loading){send.classList.add("active");send.removeAttribute("disabled");}else{send.classList.remove("active");send.setAttribute("disabled","disabled");}});send.addEventListener("click",()=>{sendFun();});input.addEventListener("keydown",(e)=>{var keyNum=window.event?e.keyCode:e.which;if(keyNum==13){sendFun();}
if(keyNum==27){model.classList.remove("live2d-chat-model-active");}});input.addEventListener("focus",()=>{message.showMessage("按下回车键可以快速发送消息哦",2000,1);});model.classList.add("live2d-chat-model-active");};window.onload=function(){localStorage.removeItem("historyMessages");};return new Live2d();}
